{% extends 'portal/base.html' %}
{% block title %}Manage Student Grades{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">📚 Manage Student Grades</h2>

    <!-- Student Selection Form -->
    <form method="get" action="{% url 'admin_manage_grades' %}" class="form-inline mb-4 d-flex align-items-center gap-2 flex-wrap">
        <label for="student_id" class="me-2">Select Student:</label>
        <select name="student_id" id="student_id" class="form-select" style="min-width: 250px;">
            <option value="">-- Select Student --</option>
            {% for student in students %}
                <option value="{{ student.id }}" {% if student_selected and student.id == student_selected.id %}selected{% endif %}>
                    {{ student.get_full_name }} ({{ student.username }})
                </option>
            {% endfor %}
        </select>
        <button type="submit" class="btn btn-primary">View Student Grades</button>
    </form>

    {% if student_selected %}
        <h4>🎓 Grades for {{ student_selected.get_full_name }} ({{ student_selected.username }})</h4>

        {% if no_grades %}
            <div class="alert alert-warning">No grades available for this student yet.</div>
        {% else %}
            <!-- Download PDF button -->
            <div class="mb-3">
                <a href="{% url 'admin_download_grade_report_pdf' student_selected.id %}" class="btn btn-primary">
                    Download PDF Report
                </a>
            </div>
            <!-- Grade Table -->
            <div class="table-responsive mb-4">
                <table class="table table-striped table-bordered align-middle">
                    <thead class="table-dark text-center">
                        <tr>
                            <th>Subject</th>
                            <th>1st Test</th>
                            <th>2nd Test</th>
                            <th>Exam</th>
                            <th>Total</th>
                            <th>1st Term</th>
                            <th>2nd Term</th>
                            <th>Average</th>
                            <th>Grade</th>
                            <th>Grade Comment</th>
                            <th>Teacher</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for grade in grades %}
                        <tr class="text-center">
                            <td>{{ grade.subject }}</td>
                            <td>{{ grade.first_test }}</td>
                            <td>{{ grade.second_test }}</td>
                            <td>{{ grade.exam }}</td>
                            <td><strong>{{ grade.total_score }}</strong></td>
                            <td>{{ grade.first_term_score }}</td>
                            <td>{{ grade.second_term_score }}</td>
                            <td>{{ grade.average_score }}</td>
                            <td>{{ grade.manual_grade|default:"–" }}</td>
                            <td>{{ grade.grade_comment|default:"–" }}</td>
                            <td>{{ grade.teacher.get_full_name|default:"–" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Report Summary -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <h5>📌 Performance Summary</h5>
                    <p><strong>Total Available Score:</strong> {{ report.total_available_score|default:"None" }}</p>
                    <p><strong>Student Overall Score:</strong> {{ report.overall_score|default:"None" }}</p>
                    <p><strong>Student Overall Average:</strong> {{ report.overall_average|default:"None" }}%</p>
                    <p><strong>Overall Position:</strong> {{ report.overall_position|default:"–" }}</p>
                </div>
                <div class="col-md-6">
                    <h5>🗣️ Teacher/Admin Comments</h5>
                    <p><strong>Teacher’s Comment:</strong> {{ report.teacher_comment|default:"–" }}</p>
                    <p><strong>Date:</strong> {{ report.date_uploaded|date:"F j, Y"|default:"–" }}</p>
                    <p><strong>Administrator’s Comment:</strong> {{ report.admin_comment_report|default:"–" }}</p>
                    <p><strong>Next Term Begins:</strong> {{ report.next_term_date|date:"F j, Y"|default:"None" }}</p>
                </div>
            </div>
        {% endif %}
    {% endif %}

    <hr class="my-5">

    <!-- Bulk Grades Management Table -->
    <h4>🗂️ All Grades Management</h4>
    {% if grades_list %}
    <div class="table-responsive">
        <table class="table table-bordered table-hover align-middle">
            <thead class="table-dark text-center">
                <tr>
                    <th>Student</th>
                    <th>Subject</th>
                    <th>1st Test</th>
                    <th>2nd Test</th>
                    <th>Exam</th>
                    <th>Total (100)</th>
                    <th>Manual Grade</th>
                    <th>Grade Comment</th>
                    <th>1st Term</th>
                    <th>2nd Term</th>
                    <th>Average</th>
                    <th>Comment</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for grade in grades_list %}
                <tr>
                    <td>{{ grade.report.student.get_full_name }} ({{ grade.report.student.username }})</td>
                    <td>{{ grade.subject }}</td>
                    <td>{{ grade.first_test|default:"–" }}</td>
                    <td>{{ grade.second_test|default:"–" }}</td>
                    <td>{{ grade.exam|default:"–" }}</td>
                    <td><strong>{{ grade.total_score }}</strong></td>
                    <td>{{ grade.manual_grade|default:"–" }}</td>
                    <td>{{ grade.grade_comment|default:"–" }}</td>
                    <td>{{ grade.first_term_score|default:"–" }}</td>
                    <td>{{ grade.second_term_score|default:"–" }}</td>
                    <td>{{ grade.average_score|default:"–" }}</td>
                    <td>{{ grade.report.term }}</td>
                    <td>{{ grade.report.session }}</td>
                    <td>{{ grade.comment|default:"–" }}</td>
                    <td>
                        <a href="{% url 'edit_student_grade' grade.id %}" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-pencil-square"></i> Edit
                        </a>
                        <a href="{% url 'delete_student_grade' grade.id %}" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure you want to delete this grade?');">
                            <i class="bi bi-trash"></i> Delete
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
        <div class="alert alert-info text-center">
            No grades found.
        </div>
    {% endif %}
</div>
{% endblock %}
