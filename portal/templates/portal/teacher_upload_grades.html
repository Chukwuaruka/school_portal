{% extends 'portal/base.html' %}
{% block title %}Upload Grades{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-4">ğŸ“ Upload or Edit Student Grades</h2>

  <!-- Grade Upload Form -->
  <form method="POST" novalidate>
    {% csrf_token %}

    <div class="row g-3">
      <div class="col-md-6">
        <label for="student_username" class="form-label">Select Student</label>
        <select id="student_username" name="student_username" class="form-select" required>
          <option value="" disabled selected>-- Select Student --</option>
          {% for student in students %}
            <option value="{{ student.username }}">{{ student.get_full_name }} ({{ student.username }})</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-6">
        <label for="classroom" class="form-label">Classroom</label>
        <select id="classroom" name="classroom" class="form-select" required>
          <option value="" disabled selected>-- Select Classroom --</option>
          {% for room in classrooms %}
            <option value="{{ room.name }}">{{ room.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-6">
        <label for="subject" class="form-label">Subject</label>
        <input type="text" id="subject" name="subject" class="form-control" required>
      </div>

      <div class="col-md-4">
        <label for="first_test" class="form-label">1st Test (out of 20)</label>
        <input type="number" id="first_test" name="first_test" class="form-control" max="20" min="0" step="1">
      </div>

      <div class="col-md-4">
        <label for="second_test" class="form-label">2nd Test (out of 20)</label>
        <input type="number" id="second_test" name="second_test" class="form-control" max="20" min="0" step="1">
      </div>

      <div class="col-md-4">
        <label for="exam" class="form-label">Exam (out of 60)</label>
        <input type="number" id="exam" name="exam" class="form-control" max="60" min="0" step="1">
      </div>

      <div class="col-md-4">
        <label for="manual_total" class="form-label">Manual Total (Optional)</label>
        <input type="number" id="manual_total" name="manual_total" class="form-control" min="0" max="100" placeholder="Override total score">
      </div>

      <div class="col-md-4">
        <label for="manual_grade" class="form-label">Manual Grade (Optional)</label>
        <input type="text" id="manual_grade" name="manual_grade" class="form-control" maxlength="3" placeholder="e.g. A, B+, C">
      </div>

      <div class="col-md-4">
        <label for="term" class="form-label">Term</label>
        <select id="term" name="term" class="form-select" required>
          <option value="" disabled selected>-- Select Term --</option>
          <option>1st Term</option>
          <option>2nd Term</option>
          <option>3rd Term</option>
        </select>
      </div>

      <div class="col-md-4">
        <label for="first_term_score" class="form-label">1st Term Score</label>
        <input type="number" id="first_term_score" name="first_term_score" class="form-control" min="0" max="100" placeholder="e.g. 65">
      </div>

      <div class="col-md-4">
        <label for="second_term_score" class="form-label">2nd Term Score</label>
        <input type="number" id="second_term_score" name="second_term_score" class="form-control" min="0" max="100" placeholder="e.g. 70">
      </div>

      <div class="col-md-4">
        <label for="average_score" class="form-label">Average (%)</label>
        <input type="number" step="0.01" id="average_score" name="average_score" class="form-control" min="0" max="100" placeholder="e.g. 67.5">
      </div>

      <div class="col-md-6">
        <label for="session" class="form-label">Session</label>
        <input type="text" id="session" name="session" class="form-control" placeholder="e.g. 2024/2025" required>
      </div>

      <div class="col-12">
        <label for="grade_comment" class="form-label">Grade Comment (Optional)</label>
        <textarea id="grade_comment" name="grade_comment" class="form-control" rows="2"></textarea>
      </div>
    </div>

    <!-- New overall report fields -->
    <hr class="my-4">
    <h4>ğŸ“Š Performance Summary (Optional)</h4>
    <div class="row g-3">
      <div class="col-md-4">
        <label for="total_available_score" class="form-label">Total Available Score</label>
        <input type="number" id="total_available_score" name="total_available_score" class="form-control" min="0" max="100" placeholder="e.g. 100">
      </div>

      <div class="col-md-4">
        <label for="overall_score" class="form-label">Overall Score</label>
        <input type="number" id="overall_score" name="overall_score" class="form-control" min="0" max="100" placeholder="e.g. 75">
      </div>

      <div class="col-md-4">
        <label for="average_score" class="form-label">Overall Average (%)</label>
        <input type="number" step="0.01" id="average_score" name="average_score" class="form-control" min="0" max="100" placeholder="e.g. 75.5">
      </div>

      <div class="col-md-4">
        <label for="overall_position" class="form-label">Overall Position</label>
        <input type="text" id="overall_position" name="overall_position" class="form-control" maxlength="20" placeholder="e.g. 5th">
      </div>

      <div class="col-md-6">
        <label for="teacher_comment" class="form-label">Teacher Comment</label>
        <textarea id="teacher_comment" name="teacher_comment" class="form-control" rows="2" placeholder="Add teacher's comment here"></textarea>
      </div>

      <div class="col-md-6">
        <label for="admin_comment_report" class="form-label">Administrator Comment</label>
        <textarea id="admin_comment_report" name="admin_comment_report" class="form-control" rows="2" placeholder="Add admin's comment here"></textarea>
      </div>

      <div class="col-md-6">
        <label for="next_term_date" class="form-label">Next Term Begins</label>
        <input type="date" id="next_term_date" name="next_term_date" class="form-control">
      </div>
    </div>

    <div class="mt-4 d-grid">
      <button type="submit" class="btn btn-primary">Submit Grade</button>
    </div>
  </form>

  {% if messages %}
    <div class="mt-3">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %}

  <hr class="my-5">

  <!-- Grade Filter -->
  <h4>ğŸ“‹ Uploaded Grades</h4>

  <form method="get" class="mb-4" aria-label="Filter grades by classroom">
    <label for="filter_classroom" class="form-label">Filter by Classroom</label>
    <select id="filter_classroom" name="classroom" class="form-select" onchange="this.form.submit()">
      <option value="">-- All Classrooms --</option>
      {% for room in classrooms %}
        <option value="{{ room.name }}" {% if selected_classroom == room.name %}selected{% endif %}>{{ room.name }}</option>
      {% endfor %}
    </select>
  </form>

  {% if student_grades %}
    {% for student, grades in student_grades.items %}
      <h5 class="mt-4 text-primary">{{ student.get_full_name }} ({{ student.username }})</h5>
      <div class="table-responsive">
        <table class="table table-bordered table-hover mt-2 align-middle">
          <thead class="table-light">
            <tr>
              <th>Subject</th>
              <th>1st Test</th>
              <th>2nd Test</th>
              <th>Exam</th>
              <th>Total (100)</th>
              <th>1st Term<br>Score</th>
              <th>2nd Term<br>Score</th>
              <th>Average</th>
              <th>Grade</th>
              <th>Grade Comment</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for grade in grades %}
              <tr>
                <td>{{ grade.subject }}</td>
                <td>{{ grade.first_test|default:"â€“" }}</td>
                <td>{{ grade.second_test|default:"â€“" }}</td>
                <td>{{ grade.exam|default:"â€“" }}</td>
                <td>{{ grade.total_score }}</td>
                <td>{{ grade.first_term_score }}</td>
                <td>{{ grade.second_term_score }}</td>
                <td>{{ grade.average_score }}</td>
                <td><strong>{{ grade.manual_grade|default:grade.grade }}</strong></td>
                <td>{{ grade.grade_comment|default:"â€“" }}</td>
                <td>
                    <a href="{% url 'edit_student_grade' grade.id %}" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-pencil-square"></i> Edit
                    </a>
                    <a href="{% url 'delete_student_grade' grade.id %}" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure you want to delete this grade?');">
                        <i class="bi bi-trash"></i> Delete
                    </a>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endfor %}
  {% else %}
    <p class="text-muted mt-3">No grades uploaded yet.</p>
  {% endif %}
</div>
{% endblock %}
