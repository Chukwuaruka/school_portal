{% extends 'portal/base.html' %}
{% block title %}Test & Examination Grades{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">📊 Test & Examination Grades</h2>

    {% if grades %}
    <div class="row">
        <!-- Grades Table -->
        <div class="col-lg-9">
            <div class="table-responsive">
                <table class="table table-bordered table-striped align-middle text-center">
                    <thead class="table-dark">
                        <tr>
                            <th>Subject</th>
                            <th>1st Test<br>(20)</th>
                            <th>2nd Test<br>(20)</th>
                            <th>Exam<br>(60)</th>
                            <th>Total<br>(100)</th>
                            <th>1st Term<br>Score</th>
                            <th>2nd Term<br>Score</th>
                            <th>Average</th>
                            <th>Grade</th>
                            <th>Comment</th>
                            <th>Teacher</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for grade in grades %}
                        <tr>
                            <td>{{ grade.subject }}</td>
                            <td>{{ grade.first_test|default:"–" }}</td>
                            <td>{{ grade.second_test|default:"–" }}</td>
                            <td>{{ grade.exam|default:"–" }}</td>
                            <td>{{ grade.total_score|default:"–" }}</td>
                            <td>{{ grade.first_term_score|default:"–" }}</td>
                            <td>{{ grade.second_term_score|default:"–" }}</td>
                            <td>{{ grade.average_score|default:"–" }}</td>
                            <td><strong>{{ grade.manual_grade|default:"–" }}</strong></td>
                            <td>{{ grade.grade_comment|default:"–" }}</td>
                            <td>{{ grade.teacher.get_full_name|default:"–" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Grade Scale -->
        <div class="col-lg-3">
            <div class="card border-secondary mb-4">
                <div class="card-header bg-dark text-white text-center">
                    Grade Scale
                </div>
                <div class="card-body small p-2">
                    <ul class="list-unstyled mb-0">
                        <li><strong>A++</strong> — 90% & Above: Outstanding</li>
                        <li><strong>A+</strong> — 80–89%: Excellent</li>
                        <li><strong>B++</strong> — 70–79%: Very Good</li>
                        <li><strong>B+</strong> — 60–69%: Good</li>
                        <li><strong>C</strong> — 50–59%: Fairly Good</li>
                        <li><strong>D</strong> — 40–49%: Fair</li>
                        <li><strong>F</strong> — 0–39%: Fail</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    {% if report %}
    <!-- Performance Summary & Comments -->
    <div class="row my-4">
        <div class="col-md-6">
            <h5>📌 Performance Summary</h5>
            <p><strong>Total Available Score:</strong> {{ report.total_available_score|default:"N/A" }}</p>
            <p><strong>Student Overall Score:</strong> {{ report.overall_score|default:"N/A" }}</p>
            <p><strong>Overall Average:</strong> {{ report.overall_average|default:"N/A" }}%</p>
            <p><strong>Overall Position:</strong> {{ report.overall_position|default:"N/A" }}</p>
        </div>
        <div class="col-md-6">
            <h5>🗣️ Teacher/Admin Comments</h5>
            <p><strong>Teacher’s Comment:</strong> {{ report.teacher_comment|default:"No comment" }}</p>
            <p><strong>Admin Comment:</strong> {{ report.admin_comment_report|default:"No comment" }}</p>
            <p><strong>Next Term Begins:</strong> {{ report.next_term_date|date:"F j, Y"|default:"TBD" }}</p>
            <p><strong>Date Uploaded:</strong> {{ report.date_uploaded|date:"F j, Y"|default:"TBD" }}</p>
        </div>
    </div>
    {% endif %}

    <!-- Behavioural Assessment -->
    {% if report.behavioural_skills.exists %}
    <div class="card border-primary mb-4">
        <div class="card-header bg-primary text-white">
            🎯 Behavioural & Psychomotor Skills
        </div>
        <div class="card-body small">
            <p><strong>Key:</strong> 5=Excellent | 4=Very Good | 3=Good | 2=Fair | 1=Needs Improvement</p>
            <div class="row">
                {% for skill in report.behavioural_skills.all %}
                <div class="col-md-3">{{ skill.skill_name }}: {{ skill.rating }}</div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- PDF Download -->
    <div class="text-center mt-4">
        <a href="{% url 'download_grade_report_pdf' %}" class="btn btn-outline-primary btn-lg" target="_blank">
            📄 Download PDF Report
        </a>
    </div>

    {% else %}
    <div class="alert alert-info text-center">
        No grades available at this time.
    </div>
    {% endif %}
</div>
{% endblock %}
